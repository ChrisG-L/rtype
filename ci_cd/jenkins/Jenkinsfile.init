pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'REBUILD_IMAGE',
            defaultValue: true,
            description: 'Reconstruire l\'image builder ?'
        )
        booleanParam(
            name: 'RESTART_CONTAINER',
            defaultValue: false,
            description: 'Forcer le redÃ©marrage du conteneur existant ?'
        )
    }

    stages {
        stage('ğŸ”§ Build Builder Image') {
            when {
                expression { params.REBUILD_IMAGE }
            }
            steps {
                script {
                    echo 'ğŸ—ï¸  Construction de l\'image builder...'
                    sh """
                        cd ci_cd/docker
                        chmod +x build_image.sh
                        ./build_image.sh
                    """
                    echo 'âœ… Image construite : rtype-builder:latest'
                }
            }
        }

        stage('ğŸ›‘ Stop Existing Builder') {
            when {
                expression { params.RESTART_CONTAINER }
            }
            steps {
                script {
                    echo 'ğŸ›‘ ArrÃªt du builder existant...'
                    sh """
                        cd ci_cd/docker
                        chmod +x stop_builder_permanent.sh
                        ./stop_builder_permanent.sh || true
                    """
                }
            }
        }

        stage('ğŸ³ Launch Permanent Builder') {
            steps {
                script {
                    echo 'ğŸš€ Lancement du builder permanent...'

                    sh """
                        cd ci_cd/docker
                        chmod +x launch_builder_permanent.sh
                        ./launch_builder_permanent.sh
                    """

                    echo 'âœ… Builder permanent lancÃ© !'
                }
            }
        }

        stage('âœ… Health Check') {
            steps {
                script {
                    echo 'ğŸ¥ VÃ©rification de la santÃ© du builder...'

                    retry(5) {
                        sleep 2
                        sh 'curl -f http://rtype_builder:8080/health'
                    }

                    echo 'âœ… Builder opÃ©rationnel !'
                }
            }
        }

        stage('ğŸ“Š Builder Info') {
            steps {
                script {
                    echo 'ğŸ“Š Informations sur le builder :'

                    def healthResponse = sh(
                        script: 'curl -s http://rtype_builder:8080/health',
                        returnStdout: true
                    ).trim()

                    echo "Health response: ${healthResponse}"

                    sh """
                        echo ""
                        echo "Container Info:"
                        docker ps --filter name=rtype_builder --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'
                        echo ""
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Builder permanent initialisÃ© avec succÃ¨s !'
            echo ''
            echo 'ğŸ”— API HTTP:   http://localhost:8080'
            echo 'ğŸ”— Rsync:      rsync://localhost:8873/workspace'
            echo ''
            echo 'Vous pouvez maintenant lancer des builds avec le Jenkinsfile principal.'
        }
        failure {
            echo 'âŒ Ã‰chec de l\'initialisation du builder'
            sh 'docker logs rtype_builder || true'
        }
    }
}
